var historyTmpl=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{}){__p+="<!-- 本地记录 -->\r\n";if(list.length>0){__p+='\r\n<div class="history-record clearfix">\r\n    <span class="fl">搜索历史</span>\r\n    <a class="fr">\r\n        <span class="icon"></span>\r\n        <span class="clear-history">清除记录</span>\r\n    </a>\r\n</div>\r\n<ul>\r\n    ';for(var i=list.length-1;i>=0;i--){__p+='\r\n    <li class="his-record-item"><a data-href href="/search?keyword='+((__t=list[i])==null?"":__t)+'">'+((__t=list[i])==null?"":__t)+"</a></li>\r\n    "}__p+="\r\n</ul>\r\n"}__p+=""}return __p};var autoCompeteTmpl=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{}){__p+="";if(list.length){__p+='\r\n<div class="option-list">\r\n    <span class="list-arrow"></span>\r\n    <ul>\r\n        ';for(var i=0;i<list.length;i++){__p+='\r\n        <li><a target="_blank" href="/search?keyword='+((__t=list[i].name)==null?"":__t)+'">'+((__t=list[i].name)==null?"":__t)+"</a></li>\r\n        "}__p+="\r\n\r\n    </ul>\r\n</div>\r\n"}__p+=""}return __p};if(/\/test[-.]|.webdev2.duowan.com|.webdev.ouj.com/.test(document.location.href)){BDY.debug=true;BDY.URL_KA="//test.ka.duowan.com/"}else if(/\/new[-.]/.test(document.location.href)){BDY.debug=false;BDY.URL_KA="//new.ka.duowan.com/"}else{BDY.debug=true;BDY.URL_KA="//ka.duowan.com/"}seajs.config({alias:{}});seajs.use(["jquery","nicescroll","lib","underscore","js/commonUtil.js?582b7117cb1c61fb"],function($,nicescroll,lib,_,commonUtil){$(document).on(BDY.pageChange,changeNav);$(document).on(BDY.onLogin,onLogin);function changeNav(){V.changeNav();V.renderHistory()}function onLogin(){try{dwUDBProxy.login("")}catch(e){}}var V={init:function(){this.initUpAdminEntrance();this.getUserInfo();this.renderHistory();$(document).trigger(BDY.pageChange)},initUpAdminEntrance:function(){var href="";if(/\/test[-.]|.webdev2.duowan.com|.webdev.ouj.com/.test(document.location.href)){href="//test-cloudadmin-up.duowan.com/admin/upload"}else{href="//cloudadmin-up.duowan.com/admin/upload"}$(".up-admin,.up-dialog-wrap .dialog-main").attr("href",href)},initScroll:function(){$(".sidebar-content").niceScroll({cursorcolor:"#dedede",cursorwidth:"5",cursorborder:"none",autohidemode:!1,background:"#f5f5f5",cursorborderradius:5,horizrailenabled:!1,railpadding:{left:5,right:5,top:5}})},changeNav:function(){if(location.pathname=="/"){$(".nav-left-item.index").addClass("active")}else{$(".nav-left-item.index").removeClass("active")}if($(".page-upz").length){$(".nav-left-item.upz").addClass("active")}else{$(".nav-left-item.upz").removeClass("active")}},initStyle:function(){if($(".mod-sidebar").hasClass("toggle")){$(".o-wrap").addClass("hide-sidebar")}else{$(".o-wrap").removeClass("hide-sidebar")}},getUserInfo:function(){dwUDBProxy.add(function(){dwUDBProxy.getUser(function(ret){var uid=ret.yyuid;$.ajax({url:"//bbs.duowan.com/api/getavatar.php",data:{uid:uid},dataType:"jsonp",success:function(ret){var avatar=ret.msg.small;$("#noLogin").hide();var img=new Image;img.src=avatar;img.onerror=function(){this.src="//att.bbs.duowan.com/avatar/noavatar_small.jpg"};$(".nav-user-info").prepend($(img).addClass("user-avatar"));$("#isLogin").show()}})})})},renderHistory:function(){if(window.localStorage){var dataStr=localStorage.getItem("searchHistory")||"[]";var list=JSON.parse(dataStr);$(".history-wrap").html(historyTmpl({list:list}))}}};var C={init:function(){var $sidebarToggleIn=$(".sidebar-toggle-in");var $sidebarToggleOut=$(".sidebar-toggle-out");$(".mod-sidebar").on("click",".btn-toggle-in,.btn-toggle-out",function(){var $this=$(this);if($this.hasClass("btn-toggle-in")){$(".mod-sidebar").addClass("toggle");$(".o-wrap").addClass("hide-sidebar")}else{$(".mod-sidebar").removeClass("toggle");$(".o-wrap").removeClass("hide-sidebar")}commonUtil.initNarrow()});$sidebarToggleOut.on("click",".type-item",function(){C.removeOtherTypeItem(this);$(this).addClass("active")});$sidebarToggleOut.on("click",".filter-catalog a",function(){$(this).addClass("active").siblings().removeClass("active");$(".mod-sidebar [data-slink]").removeClass("active")});$sidebarToggleOut.on("click",".game-catalog .game",function(){var $this=$(this);var sameLink=$this.attr("data-slink");$(".sidebar-toggle-in a").removeClass("active");$(".mod-sidebar [data-slink]").removeClass("active");$('.mod-sidebar [data-slink="'+sameLink+'"]').addClass("active");$(".mod-sidebar .filter-catalog a").removeClass("active");$this.addClass("active").siblings().removeClass("active")});$sidebarToggleOut.on("click",".toggle-menu",function(){$(this).toggleClass("current")});$sidebarToggleIn.on("click","ul a",function(){var $this=$(this);var sameLink=$this.attr("data-slink");if($this.hasClass("to-toggle")){$(".btn-toggle-out").trigger("click")}else{$(".sidebar-toggle-in ul a").removeClass("active");$this.addClass("active");$(".mod-sidebar [data-slink]").removeClass("active");$('.mod-sidebar [data-slink="'+sameLink+'"]').addClass("active");$(".mod-sidebar .filter-catalog a").removeClass("active")}});$("#login").on("click",function(){dwUDBProxy.login("")});$("#logout").on("click",function(){dwUDBProxy.logout(location.href)});$(window).on("scroll",function(){if($(document).height()-$(window).height()-$(document).scrollTop()<400){$(".btn-list-more").click()}});$("body").on("click",".clear-history",function(){$(".history-wrap ul").html("");if(window.localStorage){localStorage.removeItem("searchHistory")}});$("[name|=keyword]").on("input propertychange",C.autoCompete);$("[name|=keyword]").on("blur",function(){$(this).parents(".dw-header-mid").removeClass("focus");setTimeout(function(){$(".option-list").remove()},300)});this.keyUpInput();$(window).on("resize",_.debounce(commonUtil.initNarrow,200));commonUtil.initPageCommonEvent()},removeOtherMenuItem:function(o){$(o).parents("ul").find("a").removeClass("active")},removeOtherTypeItem:function(o){$(o).parents(".sub-type").find("a").removeClass("active")},autoCompete:function(){var $input=$("[name|=keyword]");var kw=$input.val();if(kw.length){$input.parents(".dw-header-mid").addClass("focus");M.getKeyMatch(kw)}else{$input.parents(".dw-header-mid").removeClass("focus");$(".option-list").remove()}},keyUpInput:function(){$("form").on("keydown",function(e){if(e.keyCode=="13"){return false}});$("[name|=keyword]").on("keyup",function(e){var $a=$(".option-list a");var index=$a.index($(".option-list a.on"));var len=$a.length;if(e.keyCode=="40"){$a.removeClass("on");if(index<0){$a.eq(0).addClass("on")}else{$a.eq(index+1).addClass("on")}}if(e.keyCode=="38"){$a.removeClass("on");if(index<0){$a.eq(len-1).addClass("on")}else{$a.eq(index-1).addClass("on")}}if(e.keyCode=="13"){var href=$(".option-list a.on").attr("href");var len=$(".option-list a").length;if(href){window.open(href)}else if(len>0){href=$(".option-list a").eq(0).attr("href");window.open(href)}else{return}}})}};var M={getKeyMatch:function(kw){if(!kw){$(".option-list").remove()}lib.get("/keyMatch",{keyword:kw},function(ret){if(!ret.data||!ret.data.list)return;var list=ret.data.list;$(".options-wrap").html(autoCompeteTmpl({list:list}))})}};V.init();C.init()});